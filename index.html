<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>SSPS</title>

  <style>
    body { font-family: sans-serif; background:#f4f4f4; margin:0; text-align:center; }
    h1 { margin:20px 0; }

    #controls input { margin:3px; }

    #teams {
      display:flex;
      justify-content:center;
      gap:20px;
      margin-top:10px;
    }

    .team {
      width:45vw;
      height:75vh;
      background:white;
      border:1px solid #ccc;
      padding:10px;
      position:relative;
      overflow:hidden;
    }

    .team-title { font-size:22px; font-weight:bold; margin-bottom:5px; }
    .player-list { min-height:20px; margin-bottom:10px; }

    .grid { position:relative; width:100%; height:calc(100% - 80px); }

    .cell {
      position:absolute;
      border:1px solid #ccc;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:0.15s;
    }

    .cell img { width:100%; height:100%; }

    .cell:hover { transform:scale(1.06); }

    .marked {
      border:2px solid red;
      filter:brightness(50%);
    }

    #player-input-box {
      background:white;
      border:1px solid #ccc;
      width:70%;
      margin:15px auto;
      padding:10px;
    }
  </style>
</head>
<body>

<h1>SSPS</h1>

<!-- 操作パネル -->
<div id="controls">
  <b>左チーム名：</b>
  <input type="text" id="leftName" value="Aチーム">
  <b>スコア：</b>
  <input type="number" id="leftScore" value="18" min="0" style="width:60px">
  <br><br>

  <b>右チーム名：</b>
  <input type="text" id="rightName" value="Bチーム">
  <b>スコア：</b>
  <input type="number" id="rightScore" value="18" min="0" style="width:60px">
  <br><br>

  左チーム画像数：<input type="number" id="leftCount" value="6" min="1" max="25">
  右チーム画像数：<input type="number" id="rightCount" value="6" min="1" max="25">
  <br><br>

  <button id="scoreBtn">スコア反映</button>
  <button id="drawBtn" disabled>画像抽選開始（読込中）</button>
</div>

<!-- プレイヤー入力 -->
<div id="player-input-box">
  <div><b>プレイヤー（最大6名）</b></div>
  <input class="player-input" id="p1" placeholder="プレイヤー1">
  <input class="player-input" id="p2" placeholder="プレイヤー2">
  <input class="player-input" id="p3" placeholder="プレイヤー3"><br>
  <input class="player-input" id="p4" placeholder="プレイヤー4">
  <input class="player-input" id="p5" placeholder="プレイヤー5">
  <input class="player-input" id="p6" placeholder="プレイヤー6">
  <br>
  <button id="assignBtn">チームに振り分け</button>
</div>

<!-- チーム枠 -->
<div id="teams">
  <div class="team">
    <div id="leftTeamTitle" class="team-title">左チーム（0）</div>
    <div id="leftPlayers" class="player-list"></div>
    <div id="left-grid" class="grid"></div>
  </div>

  <div class="team">
    <div id="rightTeamTitle" class="team-title">右チーム（0）</div>
    <div id="rightPlayers" class="player-list"></div>
    <div id="right-grid" class="grid"></div>
  </div>
</div>

<script>
  let allImages = [];

  /* =========================
      images.json 読み込み
  ========================== */
  fetch("images.json")
    .then(r => r.json())
    .then(json => {
      allImages = json;
      document.getElementById("drawBtn").disabled = false;
      document.getElementById("drawBtn").innerText = "画像抽選開始";
    });

  /* =========================
      プレイヤー振り分け
  ========================== */
  assignBtn.onclick = () => {
    const names = [];
    for (let i = 1; i <= 6; i++) {
      const v = document.getElementById("p" + i).value.trim();
      if (v) names.push(v);
    }
    const shuffled = [...names].sort(() => Math.random() - 0.5);

    const left = shuffled.filter((_, i) => i % 2 === 0);
    const right = shuffled.filter((_, i) => i % 2 === 1);

    leftPlayers.innerText = left.join(" / ");
    rightPlayers.innerText = right.join(" / ");
  };

  /* =========================
      スコア更新
  ========================== */
  scoreBtn.onclick = () => {
    leftTeamTitle.innerText = `${leftName.value}（${leftScore.value}）`;
    rightTeamTitle.innerText = `${rightName.value}（${rightScore.value}）`;
  };

  /* =========================
      正方形リサイズ
  ========================== */
  function resizeImage(src, size = 256) {
    return new Promise(res => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = src;

      img.onload = () => {
        const c = document.createElement("canvas");
        c.width = size;
        c.height = size;
        const ctx = c.getContext("2d");

        const s = Math.min(img.width, img.height);
        ctx.drawImage(img,
          (img.width - s) / 2,
          (img.height - s) / 2,
          s, s,
          0, 0, size, size
        );

        res(c.toDataURL());
      };
    });
  }

  /* =========================
      グリッド描画
  ========================== */
  async function drawGrid(gridId, count, files) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = "";

    const W = grid.clientWidth;
    const H = grid.clientHeight;

    const cols = Math.ceil(Math.sqrt(count));
    const rows = Math.ceil(count / cols);
    const size = Math.min(W / cols, H / rows);

    for (let i = 0; i < files.length; i++) {
      const x = i % cols;
      const y = Math.floor(i / cols);

      const div = document.createElement("div");
      div.className = "cell";
      div.style.width = `${size}px`;
      div.style.height = `${size}px`;
      div.style.left = `${x * size}px`;
      div.style.top = `${y * size}px`;

      const img = document.createElement("img");
      img.src = await resizeImage("images/" + files[i]);

      div.appendChild(img);
      div.onclick = () => div.classList.toggle("marked");

      grid.appendChild(div);
    }
  }

  /* =========================
      抽選開始
  ========================== */
  drawBtn.onclick = async () => {
    const L = Number(leftCount.value);
    const R = Number(rightCount.value);

    const shuffled = [...allImages].sort(() => Math.random() - 0.5);

    drawGrid("left-grid",  L, shuffled.slice(0, L));
    drawGrid("right-grid", R, shuffled.slice(L, L + R));
  };
</script>

</body>
</html>



